<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>STL Reader</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
</head>
<script src="jquery-1.11.1.min.js"></script>
<script src="three.min.js"></script>
<script src="OrbitControls.js"></script>
<body>

	<input type="file" id="stl_input" onchange="handleStlFile(this.files)">
	<div class="disp-stl"></div>
</body>

<script>
	var scene = new THREE.Scene();
	var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

	var renderer = new THREE.WebGLRenderer({antialias:true});
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	camera.position.set( -40, -40, 10 );

	cameraControls = new THREE.OrbitControls(camera, renderer.domElement);
	cameraControls.target.set( 0, 0, 0);
	cameraControls.maxDistance = 400;
	cameraControls.minDistance = 10;
	cameraControls.update();
	
	var ambientLight = new THREE.AmbientLight(0x330000);
  scene.add(ambientLight);
				
	var pointLight = new THREE.PointLight(0xffffff);
	pointLight.position.set( 100, 100, 100 );
	scene.add( pointLight );
	
	var directionalLight = new THREE.DirectionalLight(0xffffff);
  directionalLight.position.set(1, 1, 1).normalize();
  scene.add(directionalLight);

	
	function render() {
		renderer.render( scene, camera );
		requestAnimationFrame( render );
		cameraControls.update();
	}
	render();
	
	
	function handleStlFile(files) {
		file = files[0]
		if (file) {
			var reader = new FileReader();
			reader.readAsText(file, "UTF-8");
			reader.onload = function (evt) {
				var regex = /(vertex\s-?[\d\.]+\s-?[\d\.]+\s-?[\d\.]+)/g;
				var matches = evt.target.result.match(regex);
				
				for (var i = 0; i < matches.length; i++) {
					split = matches[i].split(" ")
					
					var geometry, v1, v2, v3;
					if (i % 3 == 0) {
						geometry = new THREE.Geometry();
						v1 = new THREE.Vector3(parseFloat(split[1]),parseFloat(split[2]),parseFloat(split[3]));
						geometry.vertices.push(v1);
					} else if (i % 3 == 1) {
						v2 = new THREE.Vector3(parseFloat(split[1]),parseFloat(split[2]),parseFloat(split[3]));
						geometry.vertices.push(v2);
					} else if (i % 3 == 2) {
						v3 = new THREE.Vector3(parseFloat(split[1]),parseFloat(split[2]),parseFloat(split[3]));
						geometry.vertices.push(v3);
						geometry.faces.push(new THREE.Face3(0, 1, 2));
						var redMat = new THREE.MeshBasicMaterial({color: 0xff0000, opacity: 0.7, transparent: true});
						var wireframe = new THREE.MeshBasicMaterial({color: 0xffff00, wireframe: true});
						var triangle = new THREE.Mesh(geometry, redMat);
						var triangle2 = new THREE.Mesh(geometry, wireframe);
						scene.add(triangle)
						scene.add(triangle2)
					}
				}
				
			}
			reader.onerror = function (evt) {
        $("div.disp-stl").html("error reading file");
			}
		}
	}
</script>

</html>